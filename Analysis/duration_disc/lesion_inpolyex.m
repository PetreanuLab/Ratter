function [cvg tm] = lesion_inpolyex(pt_side)

% example script to compute lesion coverage using inpolyex

% ---------------------------------------------------------------
% Sample data
% coordinates for AuD
AuD_lesioncoords = 0;
AuD_lesioncoords.R1 = [ ...
87.12890625 331.67724609375; ...
85.8388671875 283.935546875; ...
154.87109375 289.0966796875; ...
158.0966796875 317.48388671875; ...
];
AuD_lesioncoords.L1 = [ ...
604.548828125 315.54833984375; ...
610.3544921875 287.1611328125; ...
680.0322265625 283.935546875; ...
676.806640625 328.45166015625; ...
];
AuD_lesioncoords.R2 = [ ...
86.5185546875 390.14794921875; ...
75.4072265625 355.33349609375; ...
155.4072265625 338.29638671875; ...
159.85205078125 356.81494140625; ...
];
AuD_lesioncoords.L2 = [ ...
679.111328125 389.4072265625; ...
691.7041015625 356.81494140625; ...
613.185546875 339.037109375; ...
607.2587890625 353.85205078125; ...
];
AuD_lesioncoords.R3 = [ ...
74.66650390625 358.29638671875; ...
71.70361328125 328.66650390625; ...
73.92578125 294.5927734375; ...
139.111328125 290.1484375; ...
150.22216796875 333.85205078125; ...
];
AuD_lesioncoords.L3 = [ ...
693.185546875 356.81494140625; ...
697.6298828125 333.111328125; ...
693.92578125 294.5927734375; ...
626.5185546875 290.888671875; ...
619.8515625 322.0; ...
616.1484375 336.07421875; ...
];

% coordinates for Eaglet
Eaglet_lesioncoords = 0;
Eaglet_lesioncoords.R1 = [ ...
92.2763671875 334.14990234375; ...
114.5625 310.150390625; ...
120.8486328125 322.14990234375; ...
134.5625 313.0068359375; ...
122.5625 258.150390625; ...
104.2763671875 236.435546875; ...
87.1337890625 272.435546875; ...
86.5625 320.4345703125; ...
92.2763671875 334.14990234375; ...
];
Eaglet_lesioncoords.L1 = [ ...
671.419921875 218.86328125; ...
651.419921875 227.86328125; ...
649.419921875 242.86328125; ...
661.419921875 256.86328125; ...
661.419921875 296.86328125; ...
670.419921875 369.86376953125; ...
679.419921875 357.86376953125; ...
682.419921875 309.86328125; ...
673.419921875 256.86328125; ...
667.419921875 238.86328125; ...
671.419921875 218.86328125; ...
];
Eaglet_lesioncoords = 0;
Eaglet_lesioncoords.R1 = [ ...
92.2763671875 334.14990234375; ...
114.5625 310.150390625; ...
120.8486328125 322.14990234375; ...
134.5625 313.0068359375; ...
122.5625 258.150390625; ...
104.2763671875 236.435546875; ...
87.1337890625 272.435546875; ...
86.5625 320.4345703125; ...
92.2763671875 334.14990234375; ...
];
Eaglet_lesioncoords.L1 = [ ...
671.419921875 218.86328125; ...
651.419921875 227.86328125; ...
649.419921875 242.86328125; ...
661.419921875 256.86328125; ...
661.419921875 296.86328125; ...
670.419921875 369.86376953125; ...
679.419921875 357.86376953125; ...
682.419921875 309.86328125; ...
673.419921875 256.86328125; ...
667.419921875 238.86328125; ...
671.419921875 218.86328125; ...
];
Eaglet_lesioncoords.L2 = [ ...
688.419921875 219.86328125; ...
668.419921875 228.86328125; ...
666.419921875 243.86328125; ...
678.419921875 257.86328125; ...
678.419921875 297.86328125; ...
687.419921875 370.86376953125; ...
696.419921875 358.86376953125; ...
699.419921875 310.86328125; ...
690.419921875 257.86328125; ...
684.419921875 239.86328125; ...
688.419921875 219.86328125; ...
];
Eaglet_lesioncoords.R2 = [ ...
77.41943359375 374.86376953125; ...
85.41943359375 363.86376953125; ...
80.41943359375 356.86376953125; ...
78.41943359375 338.86376953125; ...
75.41943359375 336.86376953125; ...
75.41943359375 302.86328125; ...
102.41943359375 247.86328125; ...
100.41943359375 229.86328125; ...
82.41943359375 225.86328125; ...
89.41943359375 248.86328125; ...
72.41943359375 275.86328125; ...
66.41943359375 318.86376953125; ...
71.41943359375 355.86376953125; ...
77.41943359375 374.86376953125; ...
];

Eaglet_lesioncoords = 0;
Eaglet_lesioncoords.R1 = [ ...
92.2763671875 334.14990234375; ...
114.5625 310.150390625; ...
120.8486328125 322.14990234375; ...
134.5625 313.0068359375; ...
122.5625 258.150390625; ...
104.2763671875 236.435546875; ...
87.1337890625 272.435546875; ...
86.5625 320.4345703125; ...
92.2763671875 334.14990234375; ...
];
Eaglet_lesioncoords.L1 = [ ...
671.419921875 218.86328125; ...
651.419921875 227.86328125; ...
649.419921875 242.86328125; ...
661.419921875 256.86328125; ...
661.419921875 296.86328125; ...
670.419921875 369.86376953125; ...
679.419921875 357.86376953125; ...
682.419921875 309.86328125; ...
673.419921875 256.86328125; ...
667.419921875 238.86328125; ...
671.419921875 218.86328125; ...
];
Eaglet_lesioncoords.L2 = [ ...
688.419921875 219.86328125; ...
668.419921875 228.86328125; ...
666.419921875 243.86328125; ...
678.419921875 257.86328125; ...
678.419921875 297.86328125; ...
687.419921875 370.86376953125; ...
696.419921875 358.86376953125; ...
699.419921875 310.86328125; ...
690.419921875 257.86328125; ...
684.419921875 239.86328125; ...
688.419921875 219.86328125; ...
];
Eaglet_lesioncoords.R2 = [ ...
77.41943359375 374.86376953125; ...
85.41943359375 363.86376953125; ...
80.41943359375 356.86376953125; ...
78.41943359375 338.86376953125; ...
75.41943359375 336.86376953125; ...
75.41943359375 302.86328125; ...
102.41943359375 247.86328125; ...
100.41943359375 229.86328125; ...
82.41943359375 225.86328125; ...
89.41943359375 248.86328125; ...
72.41943359375 275.86328125; ...
66.41943359375 318.86376953125; ...
71.41943359375 355.86376953125; ...
77.41943359375 374.86376953125; ...
];
Eaglet_lesioncoords.R3 = [ ...
77.41943359375 337.86376953125; ...
100.41943359375 313.86376953125; ...
106.41943359375 326.86376953125; ...
120.41943359375 316.86376953125; ...
108.41943359375 262.86328125; ...
90.41943359375 240.86328125; ...
72.41943359375 275.86328125; ...
75.41943359375 324.86376953125; ...
77.41943359375 337.86376953125; ...
];
Eaglet_lesioncoords.L3 = [ ...
685.419921875 220.86328125; ...
665.419921875 229.86328125; ...
663.419921875 244.86328125; ...
675.419921875 258.86328125; ...
675.419921875 298.86328125; ...
684.419921875 371.86376953125; ...
693.419921875 359.86376953125; ...
696.419921875 311.86376953125; ...
687.419921875 258.86328125; ...
681.419921875 240.86328125; ...
685.419921875 220.86328125; ...
];

% ---------------------------------------------------------------
% variables
graphic = 1;
verbose = 0;
area_per_pt = pt_side ^2;
%pt_wt =10; pt_ht = 10;

% Computation work
currHem = 'R';
currSlice = '3';
ratname = 'Eaglet';
brainarea = 'AuD';

br = eval([brainarea '_lesioncoords.' currHem currSlice]);
min_br = [ min(br(:,1)) min(br(:,2))]; max_br = [max(br(:,1)) max(br(:,2))];

rt = eval([ratname '_lesioncoords.' currHem currSlice]);
min_rt = [ min(rt(:,1)) min(rt(:,2))]; max_rt = [max(rt(:,1)) max(rt(:,2))];

%[xx xy] = curveintersect(br(:,1), br(:,2), rt(:,1), rt(:,2));
tic

% plot intersection points
%plot(xx, xy,'go','MarkerSize',20,'LineWidth',2);

% superimpose point grid
%msize = 5;
msize=7;
lwdth = 3;

minx = min(min_br(:,1), min_rt(:,1)); 
miny = min(min_br(:,2), min_rt(:,2));

maxx = max(max_br(:,1), max_rt(:,1)); 
maxy = max(max_br(:,2), max_rt(:,2));

% placement of first point must be random.
rand('twister', sum(100*clock)); % new seed
st_rnd = rand(1,2) .* pt_side;

pts_x = (minx-pt_side)+st_rnd(:,1):pt_side:(maxx+pt_side)+st_rnd(:,1);
pts_y = (miny-pt_side)+st_rnd(:,2):pt_side:(maxy+pt_side)+st_rnd(:,2);

pts_array = [];
for k = 1:length(pts_y)
    currrow(:,1) = pts_x;
    currrow(:,2) = ones(size(pts_x)) * pts_y(k);
    pts_array = vertcat(pts_array, currrow);
end;

% find points in brain area
idx_ba = inpoly(pts_array,br);
pts_in_ba = find(idx_ba == 1);
% now find points in lesion area
idx_rt = inpoly(pts_array,rt);
% now show the intersection in green
both = intersect(find(idx_ba == 1), find(idx_rt == 1));

if graphic > 0
% ----------
% Graphics begin here
% Plot lesion & brain area polygons
figure; 
%plot brain area polygon
patch(br(:,1), br(:,2), 'r' ,'FaceColor','none','EdgeColor', 'b' ,'LineWidth',2,'LineStyle',':');
%now plot lesion polygon from rat
hold on;
patch(rt(:,1), rt(:,2),'r','FaceColor','none','EdgeColor', 'r' ,'LineWidth',2,'LineStyle',':');

% Plot points for each domain
% visualize points
plot(pts_array(:,1),pts_array(:,2),'+k','Color', [1 1 1]*0.85,'MarkerSize',msize,'LineWidth',lwdth);
% in brain area
plot(pts_array(idx_ba,1), pts_array(idx_ba,2),'+b','MarkerSize',msize,'LineWidth',lwdth);
% in lesion
plot(pts_array(idx_rt,1), pts_array(idx_rt,2),'+r','MarkerSize',msize,'LineWidth',lwdth);
plot(pts_array(both,1), pts_array(both,2),'+g','MarkerSize',msize,'LineWidth',lwdth);

% resize figure to make it square
xlim = get(gca,'XLim'); ylim = get(gca,'YLim');
set(gcf,'Position',[200 200 diff(xlim)*3 diff(ylim)*3]);
set(gca,'Position',[0.07 0.05 0.9 0.9]);

end; 

cvg =  (length(both) ./ length(pts_in_ba));
tm = toc;

if verbose > 0
% ----------
% Verbose output
dashes = repmat('-',1,50);
fprintf(1,'%s\n',dashes);
fprintf(1,'Base information:\n\tRat %s\n\tAtlas ROI = %s\n\tSlice = %i\n\tHem = %s\n', ratname, brainarea, str2double(currSlice), currHem);
fprintf(1, 'Point-count:\n\tIn %s: %i\n\t# intersecting points = %i\n\t%% Coverage for this slice = %2.1f\n', ...
    brainarea, length(pts_in_ba), length(both), (length(both) ./ length(pts_in_ba))*100);
fprintf(1, 'Area:\n\t%s = %2.1f pts^2 \n\tLesioned=%2.1f pts^2\n', ...
    brainarea, sub__area(length(pts_in_ba), area_per_pt), sub__area(length(both), area_per_pt));
fprintf(1,'Time taken = %2.3f seconds\n', tm);
fprintf(1,'%s\n',dashes);
end;




% plot volume
if 0
currHem = 'R';
volset = [];
for k = 1:3
    sl = eval([ratname '_lesioncoords.' currHem num2str(k)]);
    tmp = [sl(:,1) sl(:,2) ones(size(sl(:,1))) * k];
    volset = vertcat(volset, tmp);    
end;
end;

function [a] = sub__area(numpoints, a_per_pt)
 a= numpoints * a_per_pt;
 







